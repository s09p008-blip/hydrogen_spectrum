<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ°´ç´ åŸå­ã‚¹ãƒšã‚¯ãƒˆãƒ« - ãƒœãƒ¼ã‚¢æ¨¡å‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <style>
    /* ========================================
       åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    ======================================== */
    :root {
      --bg-dark: #0a0e17;
      --bg-card: #141b2d;
      --bg-card-hover: #1a2340;
      --border-color: #2a3654;
      --text-primary: #e8eaf0;
      --text-secondary: #8892a8;
      --text-dim: #5a6478;
      --accent-blue: #4a9eff;
      --accent-cyan: #00d4aa;
      --accent-purple: #a855f7;
      --accent-red: #ff6b6b;
      --accent-orange: #ff9f43;
      --accent-yellow: #ffd93d;
      --glow-blue: rgba(74, 158, 255, 0.4);
      --glow-cyan: rgba(0, 212, 170, 0.4);
      
      /* ç³»åˆ—ã®è‰² */
      --lyman-color: #a855f7;
      --balmer-color: #4a9eff;
      --paschen-color: #ff6b6b;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    
    /* ========================================
       å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰
    ======================================== */
    .app-container {
      display: grid;
      grid-template-columns: 1fr 1fr 200px;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      padding: 12px;
      min-height: 100vh;
      min-height: 100dvh;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ========================================
       ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
    ======================================== */
    .header {
      grid-column: 1 / -1;
      text-align: center;
      padding: 8px 0;
    }
    
    .header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: 0.03em;
    }
    
    .header h1 span {
      color: var(--accent-cyan);
    }
    
    /* ========================================
       å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
    ======================================== */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
      opacity: 0.5;
    }
    
    .section-title {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .section-title::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent-cyan);
      border-radius: 50%;
      box-shadow: 0 0 6px var(--glow-cyan);
    }
    
    /* ========================================
       ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒœãƒ¼ã‚¢æ¨¡å‹ï¼‹ã‚¨ãƒãƒ«ã‚®ãƒ¼æº–ä½å›³ï¼‰
    ======================================== */
    .main-area {
      grid-column: 1 / 3;
      display: flex;
      gap: 0;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    
    .bohr-section {
      flex: 1;
      padding: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      border-right: 1px solid var(--border-color);
    }
    
    .energy-section {
      width: 160px;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    
    #bohrCanvas {
      flex: 1;
      border-radius: 8px;
      cursor: grab;
      background: radial-gradient(ellipse at center, #0f1525 0%, #080c14 100%);
      touch-action: none;
    }
    
    #bohrCanvas:active {
      cursor: grabbing;
    }
    
    #energyCanvas {
      flex: 1;
      border-radius: 8px;
      background: linear-gradient(180deg, #0f1525 0%, #080c14 100%);
    }
    
    .instruction {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: var(--text-dim);
      background: rgba(10, 14, 23, 0.9);
      padding: 6px 12px;
      border-radius: 16px;
      pointer-events: none;
      white-space: nowrap;
    }
    
    /* ========================================
       ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«
    ======================================== */
    .control-section {
      grid-column: 3;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .control-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .btn {
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      color: #000;
      box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
    }
    
    .btn-primary:hover, .btn-primary:active {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 212, 170, 0.4);
    }
    
    .btn-secondary {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover, .btn-secondary:active {
      background: #1f2a45;
      border-color: var(--accent-blue);
    }
    
    /* ç³»åˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .series-filters {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      min-height: 40px;
    }
    
    .filter-item:hover, .filter-item:active {
      background: rgba(255,255,255,0.05);
    }
    
    .filter-item input[type="checkbox"] {
      display: none;
    }
    
    .filter-checkbox {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .filter-item input:checked + .filter-checkbox {
      border-color: var(--accent-cyan);
      background: var(--accent-cyan);
    }
    
    .filter-item input:checked + .filter-checkbox::after {
      content: 'âœ“';
      color: #000;
      font-size: 11px;
      font-weight: bold;
    }
    
    .filter-label {
      font-size: 0.75rem;
      flex: 1;
    }
    
    .filter-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .filter-dot.lyman { background: var(--lyman-color); box-shadow: 0 0 6px var(--lyman-color); }
    .filter-dot.balmer { background: var(--balmer-color); box-shadow: 0 0 6px var(--balmer-color); }
    .filter-dot.paschen { background: var(--paschen-color); box-shadow: 0 0 6px var(--paschen-color); }
    
    /* æƒ…å ±è¡¨ç¤º */
    .info-box {
      background: rgba(74, 158, 255, 0.1);
      border: 1px solid rgba(74, 158, 255, 0.3);
      border-radius: 8px;
      padding: 10px;
    }
    
    .info-title {
      font-size: 0.7rem;
      color: var(--accent-blue);
      margin-bottom: 6px;
    }
    
    .info-content {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .info-highlight {
      color: var(--accent-cyan);
      font-weight: 600;
    }
    
    /* ========================================
       ã‚¹ãƒšã‚¯ãƒˆãƒ«è¡¨ç¤ºéƒ¨
    ======================================== */
    .spectrum-section {
      grid-column: 1 / -1;
    }
    
    .spectrum-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    #spectrumCanvas {
      width: 100%;
      height: 120px;
      border-radius: 8px;
      background: linear-gradient(180deg, #0a0e17 0%, #050810 100%);
    }
    
    /* å‡¡ä¾‹ */
    .spectrum-legend {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    
    .legend-bar {
      width: 20px;
      height: 4px;
      border-radius: 2px;
    }
    
    .legend-bar.uv {
      background: linear-gradient(90deg, #6b21a8, #a855f7);
    }
    
    .legend-bar.visible {
      background: linear-gradient(90deg, #7c3aed, #3b82f6, #10b981, #eab308, #f97316, #ef4444);
    }
    
    .legend-bar.ir {
      background: linear-gradient(90deg, #dc2626, #7f1d1d);
    }
    
    /* ========================================
       ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œï¼ˆæ¨ªå‘ãï¼‰
    ======================================== */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr 180px;
        grid-template-rows: auto 1fr auto;
      }
      
      .main-area {
        grid-column: 1;
      }
      
      .energy-section {
        width: 140px;
      }
      
      .control-section {
        grid-column: 2;
        grid-row: 2;
      }
    }
    
    /* ========================================
       ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å¯¾å¿œï¼ˆç¸¦å‘ãï¼‰
    ======================================== */
    @media (max-width: 768px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        gap: 10px;
        padding: 10px;
      }
      
      .header h1 {
        font-size: 1.1rem;
      }
      
      .main-area {
        grid-column: 1;
        min-height: 350px;
      }
      
      .energy-section {
        width: 120px;
      }
      
      .control-section {
        grid-column: 1;
        grid-row: 3;
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .control-section .card {
        flex: 1;
        min-width: 140px;
      }
      
      .spectrum-section {
        grid-column: 1;
        grid-row: 4;
      }
      
      #spectrumCanvas {
        height: 100px;
      }
      
      .instruction {
        font-size: 0.65rem;
        padding: 5px 10px;
      }
    }
    
    /* ========================================
       å°ã•ã„ã‚¹ãƒãƒ›å¯¾å¿œ
    ======================================== */
    @media (max-width: 480px) {
      .app-container {
        padding: 8px;
        gap: 8px;
      }
      
      .header h1 {
        font-size: 1rem;
      }
      
      .main-area {
        flex-direction: column;
        min-height: 400px;
      }
      
      .bohr-section {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        min-height: 250px;
      }
      
      .energy-section {
        width: 100%;
        min-height: 150px;
      }
      
      .control-section {
        flex-direction: column;
      }
      
      .control-section .card {
        width: 100%;
      }
      
      .series-filters {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .filter-item {
        flex: 1;
        min-width: 100px;
      }
      
      .btn {
        padding: 12px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
      <h1>æ°´ç´ åŸå­ã®<span>ã‚¹ãƒšã‚¯ãƒˆãƒ«</span></h1>
    </header>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒœãƒ¼ã‚¢æ¨¡å‹ï¼‹ã‚¨ãƒãƒ«ã‚®ãƒ¼æº–ä½å›³ã‚’æ¨ªä¸¦ã³ï¼‰ -->
    <div class="main-area">
      <section class="bohr-section">
        <div class="section-title">ãƒœãƒ¼ã‚¢æ¨¡å‹</div>
        <canvas id="bohrCanvas"></canvas>
        <div class="instruction">ğŸ’¡ é›»å­ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åˆ¥ã®è»Œé“ã¸ç§»å‹•ï¼ˆå†…å´ã§æ”¾å‡ºã€å¤–å´ã§åŠ±èµ·ï¼‰</div>
      </section>
      
      <section class="energy-section">
        <div class="section-title">ã‚¨ãƒãƒ«ã‚®ãƒ¼</div>
        <canvas id="energyCanvas"></canvas>
      </section>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <section class="control-section">
      <div class="card">
        <div class="control-group">
          <div class="control-label">æ“ä½œ</div>
          <button class="btn btn-primary" id="resetBtn">ğŸ”„ n=6 ã«æˆ»ã™</button>
          <button class="btn btn-secondary" id="clearSpectrumBtn">ğŸ§¹ ã‚¹ãƒšã‚¯ãƒˆãƒ«æ¶ˆå»</button>
        </div>
      </div>
      
      <div class="card">
        <div class="control-group">
          <div class="control-label">ç³»åˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
          <div class="series-filters">
            <label class="filter-item">
              <input type="checkbox" id="showLyman" checked>
              <span class="filter-checkbox"></span>
              <span class="filter-label">ãƒ©ã‚¤ãƒãƒ³</span>
              <span class="filter-dot lyman"></span>
            </label>
            <label class="filter-item">
              <input type="checkbox" id="showBalmer" checked>
              <span class="filter-checkbox"></span>
              <span class="filter-label">ãƒãƒ«ãƒãƒ¼</span>
              <span class="filter-dot balmer"></span>
            </label>
            <label class="filter-item">
              <input type="checkbox" id="showPaschen" checked>
              <span class="filter-checkbox"></span>
              <span class="filter-label">ãƒ‘ãƒƒã‚·ã‚§ãƒ³</span>
              <span class="filter-dot paschen"></span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="info-box">
          <div class="info-title">ğŸ“Š æœ€å¾Œã®é·ç§»</div>
          <div class="info-content" id="transitionInfo">
            é›»å­ã‚’ç§»å‹•ã•ã›ã‚‹ã¨<br>ã“ã“ã«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br><span style="color:var(--text-dim);font-size:0.7rem;">å†…å´â†’æ”¾å‡º / å¤–å´â†’åŠ±èµ·</span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ã‚¹ãƒšã‚¯ãƒˆãƒ«è¡¨ç¤º -->
    <section class="spectrum-section card">
      <div class="spectrum-header">
        <div class="section-title">æ”¾å‡ºã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼ˆç´¯ç©è¨˜éŒ²ï¼‰</div>
      </div>
      <canvas id="spectrumCanvas"></canvas>
      <div class="spectrum-legend">
        <div class="legend-item">
          <div class="legend-bar uv"></div>
          <span>ç´«å¤–ç·š</span>
        </div>
        <div class="legend-item">
          <div class="legend-bar visible"></div>
          <span>å¯è¦–å…‰</span>
        </div>
        <div class="legend-item">
          <div class="legend-bar ir"></div>
          <span>èµ¤å¤–ç·š</span>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ========================================
    // ç‰©ç†å®šæ•°ã¨è¨ˆç®—
    // ========================================
    const PHYSICS = {
      // æ°´ç´ åŸå­ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼æº–ä½ï¼ˆeVï¼‰: E_n = -13.6 / n^2
      getEnergy: (n) => -13.6 / (n * n),
      
      // é·ç§»ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆeVï¼‰: Î”E = E_final - E_initial
      getTransitionEnergy: (nFrom, nTo) => {
        return PHYSICS.getEnergy(nTo) - PHYSICS.getEnergy(nFrom);
      },
      
      // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‹ã‚‰æ³¢é•·ã¸å¤‰æ›ï¼ˆnmï¼‰: Î» = hc/E = 1240/E
      energyToWavelength: (energyEV) => {
        return 1240 / Math.abs(energyEV);
      },
      
      // æ³¢é•·ã‹ã‚‰è‰²ã¸å¤‰æ›ï¼ˆRGBï¼‰
      wavelengthToColor: (wavelength) => {
        let r, g, b;
        
        if (wavelength < 380) {
          // ç´«å¤–ç·šï¼ˆç´«ã§è¡¨ç¾ï¼‰
          r = 147; g = 51; b = 234;
        } else if (wavelength < 440) {
          // ç´«
          r = Math.floor(255 * (440 - wavelength) / 60 + 100);
          g = 0;
          b = 255;
        } else if (wavelength < 490) {
          // é’â†’ã‚·ã‚¢ãƒ³
          r = 0;
          g = Math.floor(255 * (wavelength - 440) / 50);
          b = 255;
        } else if (wavelength < 510) {
          // ã‚·ã‚¢ãƒ³â†’ç·‘
          r = 0;
          g = 255;
          b = Math.floor(255 * (510 - wavelength) / 20);
        } else if (wavelength < 580) {
          // ç·‘â†’é»„
          r = Math.floor(255 * (wavelength - 510) / 70);
          g = 255;
          b = 0;
        } else if (wavelength < 645) {
          // é»„â†’èµ¤
          r = 255;
          g = Math.floor(255 * (645 - wavelength) / 65);
          b = 0;
        } else if (wavelength < 780) {
          // èµ¤
          r = 255;
          g = 0;
          b = 0;
        } else {
          // èµ¤å¤–ç·šï¼ˆæš—ã„èµ¤ã§è¡¨ç¾ï¼‰
          r = 180; g = 50; b = 50;
        }
        
        return { r, g, b };
      },
      
      // ç³»åˆ—ã®åˆ¤å®š
      getSeries: (nTo) => {
        if (nTo === 1) return 'lyman';
        if (nTo === 2) return 'balmer';
        if (nTo === 3) return 'paschen';
        return 'other';
      },
      
      // ç³»åˆ—åï¼ˆæ—¥æœ¬èªï¼‰
      getSeriesName: (series) => {
        const names = {
          lyman: 'ãƒ©ã‚¤ãƒãƒ³ç³»åˆ—',
          balmer: 'ãƒãƒ«ãƒãƒ¼ç³»åˆ—',
          paschen: 'ãƒ‘ãƒƒã‚·ã‚§ãƒ³ç³»åˆ—',
          other: 'ãã®ä»–'
        };
        return names[series] || series;
      },
      
      // å…‰ã®ç¨®é¡
      getLightType: (wavelength) => {
        if (wavelength < 380) return 'ç´«å¤–ç·š (UV)';
        if (wavelength <= 780) return 'å¯è¦–å…‰';
        return 'èµ¤å¤–ç·š (IR)';
      }
    };
    
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    // ========================================
    const state = {
      electronN: 4,               // é›»å­ã®ç¾åœ¨ã®è»Œé“ï¼ˆn=1ã€œ6ï¼‰
      electronPos: { x: 0, y: 0 }, // é›»å­ã®ç¾åœ¨ä½ç½®
      isDragging: false,
      dragStartN: null,
      dragTargetN: null,          // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè»Œé“
      dragCurrentPos: null,       // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ç¾åœ¨ä½ç½®
      emittedPhotons: [],         // æ”¾å‡ºã•ã‚ŒãŸå…‰å­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
      spectrumLines: [],          // ã‚¹ãƒšã‚¯ãƒˆãƒ«ã«è¨˜éŒ²ã•ã‚ŒãŸç·š
      lastTransition: null,       // æœ€å¾Œã®é·ç§»æƒ…å ±
      filters: {
        lyman: true,
        balmer: true,
        paschen: true
      }
    };
    
    // ========================================
    // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
    // ========================================
    const bohrCanvas = document.getElementById('bohrCanvas');
    const bohrCtx = bohrCanvas.getContext('2d');
    const energyCanvas = document.getElementById('energyCanvas');
    const energyCtx = energyCanvas.getContext('2d');
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    const spectrumCtx = spectrumCanvas.getContext('2d');
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
    function resizeCanvases() {
      const dpr = window.devicePixelRatio || 1;
      
      // ãƒœãƒ¼ã‚¢æ¨¡å‹ã‚­ãƒ£ãƒ³ãƒã‚¹
      const bohrRect = bohrCanvas.getBoundingClientRect();
      bohrCanvas.width = bohrRect.width * dpr;
      bohrCanvas.height = bohrRect.height * dpr;
      bohrCtx.setTransform(1, 0, 0, 1, 0, 0);
      bohrCtx.scale(dpr, dpr);
      
      // ã‚¨ãƒãƒ«ã‚®ãƒ¼æº–ä½ã‚­ãƒ£ãƒ³ãƒã‚¹
      const energyRect = energyCanvas.getBoundingClientRect();
      energyCanvas.width = energyRect.width * dpr;
      energyCanvas.height = energyRect.height * dpr;
      energyCtx.setTransform(1, 0, 0, 1, 0, 0);
      energyCtx.scale(dpr, dpr);
      
      // ã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚­ãƒ£ãƒ³ãƒã‚¹
      const specRect = spectrumCanvas.getBoundingClientRect();
      spectrumCanvas.width = specRect.width * dpr;
      spectrumCanvas.height = specRect.height * dpr;
      spectrumCtx.setTransform(1, 0, 0, 1, 0, 0);
      spectrumCtx.scale(dpr, dpr);
    }
    
    // ========================================
    // ãƒœãƒ¼ã‚¢æ¨¡å‹ã®æç”»
    // ========================================
    function drawBohrModel() {
      const width = bohrCanvas.getBoundingClientRect().width;
      const height = bohrCanvas.getBoundingClientRect().height;
      const centerX = width / 2;
      const centerY = height / 2;
      const maxRadius = Math.min(width, height) * 0.42;
      
      // ã‚¯ãƒªã‚¢
      bohrCtx.clearRect(0, 0, width, height);
      
      // èƒŒæ™¯ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const bgGrad = bohrCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius * 1.5);
      bgGrad.addColorStop(0, 'rgba(20, 30, 60, 0.3)');
      bgGrad.addColorStop(1, 'rgba(10, 14, 23, 0)');
      bohrCtx.fillStyle = bgGrad;
      bohrCtx.fillRect(0, 0, width, height);
      
      // è»Œé“ã‚’æç”»ï¼ˆn=1ã€œ6ï¼‰
      for (let n = 1; n <= 6; n++) {
        const radius = getOrbitRadius(n, maxRadius);
        
        bohrCtx.beginPath();
        bohrCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè»Œé“ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if (state.isDragging && n === state.dragTargetN && n !== state.electronN) {
          // ä¸‹ã¸ã®é·ç§»ï¼ˆæ”¾å‡ºï¼‰ã¯é»„è‰²ã€ä¸Šã¸ã®é·ç§»ï¼ˆåŠ±èµ·ï¼‰ã¯æ°´è‰²
          const isEmissionTarget = n < state.electronN;
          if (isEmissionTarget) {
            bohrCtx.strokeStyle = 'rgba(255, 217, 61, 0.9)';
            bohrCtx.shadowColor = 'rgba(255, 217, 61, 0.7)';
          } else {
            bohrCtx.strokeStyle = 'rgba(100, 200, 255, 0.9)';
            bohrCtx.shadowColor = 'rgba(100, 200, 255, 0.7)';
          }
          bohrCtx.lineWidth = 4;
          bohrCtx.shadowBlur = 15;
        }
        // é›»å­ãŒã„ã‚‹è»Œé“
        else if (n === state.electronN) {
          bohrCtx.strokeStyle = 'rgba(0, 212, 170, 0.8)';
          bohrCtx.lineWidth = 2.5;
          bohrCtx.shadowColor = 'rgba(0, 212, 170, 0.5)';
          bohrCtx.shadowBlur = 10;
        }
        // é·ç§»å¯èƒ½ãªè»Œé“ï¼ˆé›»å­ã¨ç•°ãªã‚‹è»Œé“ï¼‰
        else if (state.isDragging && n !== state.electronN) {
          bohrCtx.strokeStyle = 'rgba(74, 158, 255, 0.5)';
          bohrCtx.lineWidth = 2;
          bohrCtx.shadowBlur = 0;
        }
        // é€šå¸¸ã®è»Œé“
        else {
          bohrCtx.strokeStyle = 'rgba(74, 158, 255, 0.25)';
          bohrCtx.lineWidth = 1;
          bohrCtx.shadowBlur = 0;
        }
        bohrCtx.stroke();
        bohrCtx.shadowBlur = 0;
        
        // è»Œé“ç•ªå·ãƒ©ãƒ™ãƒ«
        const labelAngle = -Math.PI / 4;
        const labelX = centerX + (radius + 12) * Math.cos(labelAngle);
        const labelY = centerY + (radius + 12) * Math.sin(labelAngle);
        
        bohrCtx.fillStyle = (state.isDragging && n === state.dragTargetN && n !== state.electronN)
          ? (n < state.electronN ? 'rgba(255, 217, 61, 0.9)' : 'rgba(100, 200, 255, 0.9)')
          : 'rgba(136, 146, 168, 0.7)';
        bohrCtx.font = '11px sans-serif';
        bohrCtx.textAlign = 'center';
        bohrCtx.fillText(`n=${n}`, labelX, labelY);
      }
      
      // åŸå­æ ¸ã‚’æç”»
      drawNucleus(bohrCtx, centerX, centerY);
      
      // é›»å­ã‚’æç”»ï¼ˆè¶…ä½é€Ÿå›è»¢ï¼‰
      const electronOrbitRadius = getOrbitRadius(state.electronN, maxRadius);
      const electronAngle = Date.now() * 0.0001;
      let electronX, electronY;
      
      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ç¾åœ¨ä½ç½®ã«è¡¨ç¤º
      if (state.isDragging && state.dragCurrentPos) {
        electronX = state.dragCurrentPos.x;
        electronY = state.dragCurrentPos.y;
      } else {
        electronX = centerX + electronOrbitRadius * Math.cos(electronAngle);
        electronY = centerY + electronOrbitRadius * Math.sin(electronAngle);
      }
      
      // é›»å­ä½ç½®ã‚’ä¿å­˜
      state.electronPos = { x: electronX, y: electronY };
      
      drawElectron(bohrCtx, electronX, electronY, state.isDragging);
      
      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±ã‚’è¡¨ç¤º
      if (state.isDragging && state.dragTargetN && state.dragTargetN !== state.electronN) {
        const targetRadius = getOrbitRadius(state.dragTargetN, maxRadius);
        const isEmissionTarget = state.dragTargetN < state.electronN;
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã®çŸ¢å°ç·šï¼ˆç‚¹ç·šï¼‰
        bohrCtx.setLineDash([5, 5]);
        bohrCtx.strokeStyle = isEmissionTarget 
          ? 'rgba(255, 217, 61, 0.5)' 
          : 'rgba(100, 200, 255, 0.5)';
        bohrCtx.lineWidth = 2;
        bohrCtx.beginPath();
        bohrCtx.moveTo(electronX, electronY);
        
        const angle = Math.atan2(electronY - centerY, electronX - centerX);
        const targetX = centerX + targetRadius * Math.cos(angle);
        const targetY = centerY + targetRadius * Math.sin(angle);
        bohrCtx.lineTo(targetX, targetY);
        bohrCtx.stroke();
        bohrCtx.setLineDash([]);
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®ã«ãƒãƒ¼ã‚«ãƒ¼
        bohrCtx.fillStyle = isEmissionTarget
          ? 'rgba(255, 217, 61, 0.6)'
          : 'rgba(100, 200, 255, 0.6)';
        bohrCtx.beginPath();
        bohrCtx.arc(targetX, targetY, 8, 0, Math.PI * 2);
        bohrCtx.fill();
      }
      
      // å…‰å­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
      drawPhotons(bohrCtx, centerX, centerY, maxRadius);
    }
    
    // è»Œé“åŠå¾„ã®è¨ˆç®—
    function getOrbitRadius(n, maxRadius) {
      return maxRadius * (0.15 + 0.14 * n);
    }
    
    // åŸå­æ ¸ã®æç”»
    function drawNucleus(ctx, x, y) {
      // ã‚°ãƒ­ãƒ¼åŠ¹æœ
      const glowGrad = ctx.createRadialGradient(x, y, 0, x, y, 20);
      glowGrad.addColorStop(0, 'rgba(255, 159, 67, 0.6)');
      glowGrad.addColorStop(0.5, 'rgba(255, 107, 107, 0.3)');
      glowGrad.addColorStop(1, 'rgba(255, 107, 107, 0)');
      ctx.fillStyle = glowGrad;
      ctx.beginPath();
      ctx.arc(x, y, 20, 0, Math.PI * 2);
      ctx.fill();
      
      // æ ¸æœ¬ä½“
      const nucGrad = ctx.createRadialGradient(x - 2, y - 2, 0, x, y, 10);
      nucGrad.addColorStop(0, '#ff9f43');
      nucGrad.addColorStop(0.7, '#ff6b6b');
      nucGrad.addColorStop(1, '#c0392b');
      ctx.fillStyle = nucGrad;
      ctx.beginPath();
      ctx.arc(x, y, 10, 0, Math.PI * 2);
      ctx.fill();
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.beginPath();
      ctx.arc(x - 3, y - 3, 3, 0, Math.PI * 2);
      ctx.fill();
      
      // ãƒ©ãƒ™ãƒ«
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 9px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('Hâº', x, y);
    }
    
    // é›»å­ã®æç”»
    function drawElectron(ctx, x, y, isDragging) {
      const radius = 12;
      
      // ã‚°ãƒ­ãƒ¼åŠ¹æœ
      const glowGrad = ctx.createRadialGradient(x, y, 0, x, y, 35);
      const glowColor = isDragging ? 'rgba(255, 217, 61, ' : 'rgba(0, 212, 170, ';
      glowGrad.addColorStop(0, glowColor + '0.9)');
      glowGrad.addColorStop(0.3, glowColor + '0.4)');
      glowGrad.addColorStop(1, glowColor + '0)');
      ctx.fillStyle = glowGrad;
      ctx.beginPath();
      ctx.arc(x, y, 35, 0, Math.PI * 2);
      ctx.fill();
      
      // é›»å­æœ¬ä½“
      const elecGrad = ctx.createRadialGradient(x - 2, y - 2, 0, x, y, radius);
      if (isDragging) {
        elecGrad.addColorStop(0, '#fff');
        elecGrad.addColorStop(0.5, '#ffd93d');
        elecGrad.addColorStop(1, '#ff9f43');
      } else {
        elecGrad.addColorStop(0, '#00ffcc');
        elecGrad.addColorStop(0.5, '#00d4aa');
        elecGrad.addColorStop(1, '#4a9eff');
      }
      ctx.fillStyle = elecGrad;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.fill();
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
      ctx.beginPath();
      ctx.arc(x - 3, y - 3, 4, 0, Math.PI * 2);
      ctx.fill();
      
      // e- ãƒ©ãƒ™ãƒ«
      ctx.fillStyle = isDragging ? '#000' : '#000';
      ctx.font = 'bold 9px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('eâ»', x, y);
    }
    
    // å…‰å­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»
    function drawPhotons(ctx, centerX, centerY, maxRadius) {
      const now = Date.now();
      
      state.emittedPhotons = state.emittedPhotons.filter(photon => {
        const elapsed = now - photon.startTime;
        const duration = 1200;
        
        if (elapsed > duration) return false;
        
        const progress = elapsed / duration;
        const easeOut = 1 - Math.pow(1 - progress, 3);
        
        const distance = maxRadius * 0.3 + maxRadius * 0.7 * easeOut;
        const x = centerX + distance * Math.cos(photon.angle);
        const y = centerY + distance * Math.sin(photon.angle);
        
        const alpha = 1 - progress;
        
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(photon.angle);
        
        // ã‚°ãƒ­ãƒ¼
        const glowGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, 18);
        glowGrad.addColorStop(0, `rgba(${photon.color.r}, ${photon.color.g}, ${photon.color.b}, ${alpha * 0.8})`);
        glowGrad.addColorStop(1, `rgba(${photon.color.r}, ${photon.color.g}, ${photon.color.b}, 0)`);
        ctx.fillStyle = glowGrad;
        ctx.beginPath();
        ctx.arc(0, 0, 18, 0, Math.PI * 2);
        ctx.fill();
        
        // æ³¢å½¢
        ctx.strokeStyle = `rgba(${photon.color.r}, ${photon.color.g}, ${photon.color.b}, ${alpha})`;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = -3; i <= 3; i++) {
          const px = i * 8;
          const py = Math.sin(i * Math.PI / 2 + now * 0.01) * 6;
          if (i === -3) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
        
        ctx.restore();
        return true;
      });
    }
    
    // ========================================
    // ã‚¨ãƒãƒ«ã‚®ãƒ¼æº–ä½å›³ã®æç”»
    // ========================================
    function drawEnergyDiagram() {
      const width = energyCanvas.getBoundingClientRect().width;
      const height = energyCanvas.getBoundingClientRect().height;
      const bohrHeight = bohrCanvas.getBoundingClientRect().height;
      const bohrCenterY = bohrHeight / 2;
      const maxRadius = Math.min(bohrCanvas.getBoundingClientRect().width, bohrHeight) * 0.42;
      
      const padding = { top: 20, bottom: 20, left: 35, right: 10 };
      
      energyCtx.clearRect(0, 0, width, height);
      
      // è»¸ã‚’æç”»
      energyCtx.strokeStyle = 'rgba(136, 146, 168, 0.4)';
      energyCtx.lineWidth = 1;
      energyCtx.beginPath();
      energyCtx.moveTo(padding.left, padding.top);
      energyCtx.lineTo(padding.left, height - padding.bottom);
      energyCtx.stroke();
      
      // å„æº–ä½ã‚’æç”»ï¼ˆãƒœãƒ¼ã‚¢æ¨¡å‹ã®è»Œé“ä½ç½®ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
      const levelWidth = width - padding.left - padding.right - 5;
      const levelStartX = padding.left + 3;
      
      for (let n = 1; n <= 6; n++) {
        const energy = PHYSICS.getEnergy(n);
        // ãƒœãƒ¼ã‚¢æ¨¡å‹ã®è»Œé“Yä½ç½®ã¨ä¸€è‡´ã•ã›ã‚‹
        const orbitRadius = getOrbitRadius(n, maxRadius);
        const y = bohrCenterY - orbitRadius; // ä¸Šå´ã®è»Œé“ä½ç½®
        
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        if (state.isDragging && n === state.dragTargetN && n !== state.electronN) {
          const isEmissionTarget = n < state.electronN;
          if (isEmissionTarget) {
            energyCtx.strokeStyle = 'rgba(255, 217, 61, 0.9)';
            energyCtx.shadowColor = 'rgba(255, 217, 61, 0.5)';
          } else {
            energyCtx.strokeStyle = 'rgba(100, 200, 255, 0.9)';
            energyCtx.shadowColor = 'rgba(100, 200, 255, 0.5)';
          }
          energyCtx.lineWidth = 3;
          energyCtx.shadowBlur = 8;
        }
        // é›»å­ãŒã„ã‚‹æº–ä½
        else if (n === state.electronN) {
          energyCtx.strokeStyle = 'rgba(0, 212, 170, 0.9)';
          energyCtx.lineWidth = 2.5;
          energyCtx.shadowColor = 'rgba(0, 212, 170, 0.5)';
          energyCtx.shadowBlur = 6;
        }
        // é€šå¸¸ã®æº–ä½
        else {
          energyCtx.strokeStyle = 'rgba(74, 158, 255, 0.5)';
          energyCtx.lineWidth = 1.5;
          energyCtx.shadowBlur = 0;
        }
        
        energyCtx.beginPath();
        energyCtx.moveTo(levelStartX, y);
        energyCtx.lineTo(levelStartX + levelWidth, y);
        energyCtx.stroke();
        energyCtx.shadowBlur = 0;
        
        // ã‚¨ãƒãƒ«ã‚®ãƒ¼å€¤ãƒ©ãƒ™ãƒ«
        let labelColor;
        if (state.isDragging && n === state.dragTargetN && n !== state.electronN) {
          labelColor = (n < state.electronN) ? '#ffd93d' : '#64c8ff';
        } else if (n === state.electronN) {
          labelColor = '#00d4aa';
        } else {
          labelColor = 'rgba(136, 146, 168, 0.7)';
        }
        energyCtx.fillStyle = labelColor;
        energyCtx.font = '9px sans-serif';
        energyCtx.textAlign = 'right';
        energyCtx.textBaseline = 'middle';
        energyCtx.fillText(`${energy.toFixed(1)}`, padding.left - 3, y);
        
        // nå€¤ãƒ©ãƒ™ãƒ«
        energyCtx.textAlign = 'left';
        energyCtx.fillText(`n=${n}`, levelStartX + levelWidth + 3, y);
      }
      
      // é›»å­ãƒãƒ¼ã‚«ãƒ¼
      const electronY = bohrCenterY - getOrbitRadius(state.electronN, maxRadius);
      energyCtx.fillStyle = state.isDragging ? '#ffd93d' : '#00d4aa';
      energyCtx.beginPath();
      energyCtx.arc(levelStartX + levelWidth / 2, electronY, 5, 0, Math.PI * 2);
      energyCtx.fill();
      
      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯é·ç§»çŸ¢å°ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (state.isDragging && state.dragTargetN && state.dragTargetN !== state.electronN) {
        const fromY = electronY;
        const toY = bohrCenterY - getOrbitRadius(state.dragTargetN, maxRadius);
        const arrowX = levelStartX + levelWidth / 2;
        const isEmissionTarget = state.dragTargetN < state.electronN;
        
        // çŸ¢å°
        const arrowColor = isEmissionTarget 
          ? 'rgba(255, 217, 61, 0.7)' 
          : 'rgba(100, 200, 255, 0.7)';
        energyCtx.strokeStyle = arrowColor;
        energyCtx.lineWidth = 2;
        energyCtx.setLineDash([4, 4]);
        energyCtx.beginPath();
        energyCtx.moveTo(arrowX, fromY);
        energyCtx.lineTo(arrowX, toY);
        energyCtx.stroke();
        energyCtx.setLineDash([]);
        
        // çŸ¢ã˜ã‚Šï¼ˆé·ç§»æ–¹å‘ã«å¿œã˜ã¦å‘ãã‚’å¤‰ãˆã‚‹ï¼‰
        energyCtx.fillStyle = arrowColor;
        energyCtx.beginPath();
        energyCtx.moveTo(arrowX, toY);
        if (isEmissionTarget) {
          // ä¸‹å‘ãçŸ¢å°ï¼ˆæ”¾å‡ºï¼‰
          energyCtx.lineTo(arrowX - 5, toY - 8);
          energyCtx.lineTo(arrowX + 5, toY - 8);
        } else {
          // ä¸Šå‘ãçŸ¢å°ï¼ˆåŠ±èµ·ï¼‰
          energyCtx.lineTo(arrowX - 5, toY + 8);
          energyCtx.lineTo(arrowX + 5, toY + 8);
        }
        energyCtx.closePath();
        energyCtx.fill();
      }
      
      // æœ€å¾Œã®é·ç§»ã‚’çŸ¢å°ã§è¡¨ç¤ºï¼ˆæ”¾å‡ºã®å ´åˆã®ã¿ï¼‰
      if (state.lastTransition && state.lastTransition.type === 'emission' && !state.isDragging) {
        const fromY = bohrCenterY - getOrbitRadius(state.lastTransition.from, maxRadius);
        const toY = bohrCenterY - getOrbitRadius(state.lastTransition.to, maxRadius);
        const arrowX = levelStartX + levelWidth / 2;
        
        const series = PHYSICS.getSeries(state.lastTransition.to);
        let arrowColor;
        if (series === 'lyman') arrowColor = 'rgba(168, 85, 247, 0.8)';
        else if (series === 'balmer') arrowColor = 'rgba(74, 158, 255, 0.8)';
        else arrowColor = 'rgba(255, 107, 107, 0.8)';
        
        energyCtx.strokeStyle = arrowColor;
        energyCtx.lineWidth = 2;
        energyCtx.beginPath();
        energyCtx.moveTo(arrowX, fromY);
        energyCtx.lineTo(arrowX, toY);
        energyCtx.stroke();
        
        energyCtx.fillStyle = arrowColor;
        energyCtx.beginPath();
        energyCtx.moveTo(arrowX, toY);
        energyCtx.lineTo(arrowX - 5, toY - 8);
        energyCtx.lineTo(arrowX + 5, toY - 8);
        energyCtx.closePath();
        energyCtx.fill();
      }
      
      // å˜ä½ãƒ©ãƒ™ãƒ«
      energyCtx.fillStyle = 'rgba(136, 146, 168, 0.5)';
      energyCtx.font = '9px sans-serif';
      energyCtx.textAlign = 'center';
      energyCtx.fillText('eV', padding.left, height - 5);
    }
    
    // ========================================
    // ã‚¹ãƒšã‚¯ãƒˆãƒ«ã®æç”»
    // ========================================
    function drawSpectrum() {
      const width = spectrumCanvas.getBoundingClientRect().width;
      const height = spectrumCanvas.getBoundingClientRect().height;
      const padding = { top: 15, bottom: 28, left: 50, right: 30 };
      
      spectrumCtx.clearRect(0, 0, width, height);
      
      // æ³¢é•·ç¯„å›²ï¼ˆnmï¼‰
      const wlMin = 80;
      const wlMax = 2000;
      
      // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã§æ³¢é•·ã‚’Xåº§æ¨™ã«å¤‰æ›
      const wlToX = (wl) => {
        const logMin = Math.log10(wlMin);
        const logMax = Math.log10(wlMax);
        const logWl = Math.log10(wl);
        return padding.left + (logWl - logMin) / (logMax - logMin) * (width - padding.left - padding.right);
      };
      
      const spectrumY = padding.top;
      const spectrumHeight = height - padding.top - padding.bottom;
      
      // UVé ˜åŸŸ
      const uvGrad = spectrumCtx.createLinearGradient(wlToX(80), 0, wlToX(380), 0);
      uvGrad.addColorStop(0, 'rgba(88, 28, 135, 0.4)');
      uvGrad.addColorStop(1, 'rgba(139, 92, 246, 0.3)');
      spectrumCtx.fillStyle = uvGrad;
      spectrumCtx.fillRect(wlToX(80), spectrumY, wlToX(380) - wlToX(80), spectrumHeight);
      
      // å¯è¦–å…‰é ˜åŸŸ
      const visGrad = spectrumCtx.createLinearGradient(wlToX(380), 0, wlToX(780), 0);
      visGrad.addColorStop(0, 'rgba(139, 92, 246, 0.6)');
      visGrad.addColorStop(0.15, 'rgba(59, 130, 246, 0.6)');
      visGrad.addColorStop(0.35, 'rgba(16, 185, 129, 0.6)');
      visGrad.addColorStop(0.55, 'rgba(234, 179, 8, 0.6)');
      visGrad.addColorStop(0.75, 'rgba(249, 115, 22, 0.6)');
      visGrad.addColorStop(1, 'rgba(239, 68, 68, 0.6)');
      spectrumCtx.fillStyle = visGrad;
      spectrumCtx.fillRect(wlToX(380), spectrumY, wlToX(780) - wlToX(380), spectrumHeight);
      
      // æ ç·š
      spectrumCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      spectrumCtx.lineWidth = 1;
      spectrumCtx.strokeRect(wlToX(380), spectrumY, wlToX(780) - wlToX(380), spectrumHeight);
      
      // IRé ˜åŸŸ
      const irGrad = spectrumCtx.createLinearGradient(wlToX(780), 0, wlToX(2000), 0);
      irGrad.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
      irGrad.addColorStop(1, 'rgba(127, 29, 29, 0.2)');
      spectrumCtx.fillStyle = irGrad;
      spectrumCtx.fillRect(wlToX(780), spectrumY, wlToX(2000) - wlToX(780), spectrumHeight);
      
      // é ˜åŸŸãƒ©ãƒ™ãƒ«
      spectrumCtx.fillStyle = 'rgba(168, 85, 247, 0.7)';
      spectrumCtx.font = '10px sans-serif';
      spectrumCtx.textAlign = 'center';
      spectrumCtx.fillText('UV', (wlToX(80) + wlToX(380)) / 2, spectrumY + 12);
      
      spectrumCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      spectrumCtx.fillText('å¯è¦–å…‰', (wlToX(380) + wlToX(780)) / 2, spectrumY + 12);
      
      spectrumCtx.fillStyle = 'rgba(239, 68, 68, 0.7)';
      spectrumCtx.fillText('IR', (wlToX(780) + wlToX(2000)) / 2, spectrumY + 12);
      
      // æ³¢é•·è»¸
      spectrumCtx.strokeStyle = 'rgba(136, 146, 168, 0.4)';
      spectrumCtx.beginPath();
      spectrumCtx.moveTo(padding.left, height - padding.bottom);
      spectrumCtx.lineTo(width - padding.right, height - padding.bottom);
      spectrumCtx.stroke();
      
      // æ³¢é•·ç›®ç››ã‚Š
      const tickWavelengths = [100, 200, 400, 600, 800, 1200, 1800];
      spectrumCtx.fillStyle = 'rgba(136, 146, 168, 0.7)';
      spectrumCtx.font = '9px sans-serif';
      spectrumCtx.textAlign = 'center';
      
      tickWavelengths.forEach(wl => {
        const x = wlToX(wl);
        spectrumCtx.beginPath();
        spectrumCtx.moveTo(x, height - padding.bottom);
        spectrumCtx.lineTo(x, height - padding.bottom + 4);
        spectrumCtx.stroke();
        spectrumCtx.fillText(`${wl}`, x, height - padding.bottom + 14);
      });
      
      spectrumCtx.fillText('æ³¢é•· (nm)', width / 2, height - 2);
      
      // è¨˜éŒ²ã•ã‚ŒãŸã‚¹ãƒšã‚¯ãƒˆãƒ«ç·š
      state.spectrumLines.forEach(line => {
        if (!state.filters[line.series]) return;
        
        const x = wlToX(line.wavelength);
        const color = line.color;
        
        // ã‚°ãƒ­ãƒ¼
        const glowGrad = spectrumCtx.createLinearGradient(x - 12, 0, x + 12, 0);
        glowGrad.addColorStop(0, `rgba(${color.r}, ${color.g}, ${color.b}, 0)`);
        glowGrad.addColorStop(0.5, `rgba(${color.r}, ${color.g}, ${color.b}, 0.4)`);
        glowGrad.addColorStop(1, `rgba(${color.r}, ${color.g}, ${color.b}, 0)`);
        spectrumCtx.fillStyle = glowGrad;
        spectrumCtx.fillRect(x - 12, spectrumY + 18, 24, spectrumHeight - 18);
        
        // è¼ç·š
        spectrumCtx.strokeStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
        spectrumCtx.lineWidth = 2;
        spectrumCtx.shadowColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
        spectrumCtx.shadowBlur = 6;
        spectrumCtx.beginPath();
        spectrumCtx.moveTo(x, spectrumY + 18);
        spectrumCtx.lineTo(x, spectrumY + spectrumHeight);
        spectrumCtx.stroke();
        spectrumCtx.shadowBlur = 0;
        
        // é·ç§»ãƒ©ãƒ™ãƒ«
        spectrumCtx.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, 0.9)`;
        spectrumCtx.font = '8px sans-serif';
        spectrumCtx.textAlign = 'center';
        spectrumCtx.fillText(`${line.from}â†’${line.to}`, x, spectrumY + spectrumHeight + 10);
      });
    }
    
    // ========================================
    // é·ç§»å‡¦ç†
    // ========================================
    function performTransition(fromN, toN) {
      if (fromN === toN) return;
      
      const isEmission = fromN > toN; // æ”¾å‡ºï¼ˆä¸‹ã¸ã®é·ç§»ï¼‰
      const energy = Math.abs(PHYSICS.getTransitionEnergy(fromN, toN));
      const wavelength = PHYSICS.energyToWavelength(energy);
      const color = PHYSICS.wavelengthToColor(wavelength);
      const series = isEmission ? PHYSICS.getSeries(toN) : null;
      
      // é›»å­ã‚’ç§»å‹•
      state.electronN = toN;
      
      if (isEmission) {
        // æ”¾å‡ºã®å ´åˆï¼šå…‰å­ã‚’ç™ºå°„ã—ã¦ã‚¹ãƒšã‚¯ãƒˆãƒ«ã«è¨˜éŒ²
        state.lastTransition = { 
          from: fromN, 
          to: toN, 
          energy, 
          wavelength, 
          series,
          type: 'emission'
        };
        
        // å…‰å­ã‚’ç™ºå°„
        for (let i = 0; i < 4; i++) {
          state.emittedPhotons.push({
            startTime: Date.now(),
            angle: Math.random() * Math.PI * 2,
            wavelength,
            color
          });
        }
        
        // ã‚¹ãƒšã‚¯ãƒˆãƒ«ç·šã‚’è¿½åŠ 
        const exists = state.spectrumLines.some(l => l.from === fromN && l.to === toN);
        if (!exists) {
          state.spectrumLines.push({ from: fromN, to: toN, wavelength, color, series });
        }
      } else {
        // åŠ±èµ·ã®å ´åˆï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã—ã€æƒ…å ±ã®ã¿æ›´æ–°
        state.lastTransition = { 
          from: fromN, 
          to: toN, 
          energy, 
          wavelength, 
          series: null,
          type: 'absorption'
        };
      }
      
      updateTransitionInfo();
    }
    
    function updateTransitionInfo() {
      const info = state.lastTransition;
      if (!info) return;
      
      if (info.type === 'emission') {
        const seriesName = PHYSICS.getSeriesName(info.series);
        const lightType = PHYSICS.getLightType(info.wavelength);
        
        document.getElementById('transitionInfo').innerHTML = `
          <strong style="color: #00d4aa;">ğŸ’¡ æ”¾å‡º</strong><br>
          n=${info.from} â†’ n=${info.to}<br>
          ${seriesName}<br>
          æ³¢é•·: <span class="info-highlight">${Math.round(info.wavelength)} nm</span><br>
          ç¨®é¡: ${lightType}
        `;
      } else {
        // åŠ±èµ·ã®å ´åˆ
        document.getElementById('transitionInfo').innerHTML = `
          <strong style="color: #ffd93d;">â¬† åŠ±èµ·</strong><br>
          n=${info.from} â†’ n=${info.to}<br>
          <span style="color: var(--text-dim);">ï¼ˆå…‰ã¯æ”¾å‡ºã•ã‚Œã¾ã›ã‚“ï¼‰</span>
        `;
      }
    }
    
    // ========================================
    // ãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒæ“ä½œ
    // ========================================
    function getCanvasPos(canvas, e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }
    
    function isClickOnElectron(x, y) {
      const dist = Math.sqrt((x - state.electronPos.x) ** 2 + (y - state.electronPos.y) ** 2);
      return dist < 40;
    }
    
    function getTargetOrbit(x, y) {
      const rect = bohrCanvas.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const maxRadius = Math.min(rect.width, rect.height) * 0.42;
      const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
      
      for (let n = 1; n <= 6; n++) {
        const orbitRadius = getOrbitRadius(n, maxRadius);
        if (Math.abs(dist - orbitRadius) < 25) {
          return n;
        }
      }
      
      // è»Œé“ã®é–“ã«ã„ã‚‹å ´åˆã€æœ€ã‚‚è¿‘ã„å†…å´ã®è»Œé“ã‚’è¿”ã™
      for (let n = 6; n >= 1; n--) {
        const orbitRadius = getOrbitRadius(n, maxRadius);
        if (dist < orbitRadius + 15) {
          return n;
        }
      }
      return null;
    }
    
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    function handleStart(e) {
      const pos = getCanvasPos(bohrCanvas, e);
      if (isClickOnElectron(pos.x, pos.y)) {
        state.isDragging = true;
        state.dragStartN = state.electronN;
        state.dragCurrentPos = pos;
        state.dragTargetN = null;
        bohrCanvas.style.cursor = 'grabbing';
        e.preventDefault();
      }
    }
    
    function handleMove(e) {
      const pos = getCanvasPos(bohrCanvas, e);
      
      if (state.isDragging) {
        state.dragCurrentPos = pos;
        const targetN = getTargetOrbit(pos.x, pos.y);
        // ç¾åœ¨ã®è»Œé“ã¨ç•°ãªã‚‹è»Œé“ãªã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«è¨­å®šï¼ˆä¸Šä¸‹ã©ã¡ã‚‰ã‚‚OKï¼‰
        state.dragTargetN = (targetN && targetN !== state.electronN) ? targetN : null;
        e.preventDefault();
      } else {
        bohrCanvas.style.cursor = isClickOnElectron(pos.x, pos.y) ? 'grab' : 'default';
      }
    }
    
    function handleEnd(e) {
      if (state.isDragging) {
        if (state.dragTargetN && state.dragTargetN !== state.electronN) {
          performTransition(state.electronN, state.dragTargetN);
        }
        state.isDragging = false;
        state.dragStartN = null;
        state.dragTargetN = null;
        state.dragCurrentPos = null;
        bohrCanvas.style.cursor = 'default';
      }
    }
    
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    bohrCanvas.addEventListener('mousedown', handleStart);
    bohrCanvas.addEventListener('mousemove', handleMove);
    bohrCanvas.addEventListener('mouseup', handleEnd);
    bohrCanvas.addEventListener('mouseleave', handleEnd);
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    bohrCanvas.addEventListener('touchstart', handleStart, { passive: false });
    bohrCanvas.addEventListener('touchmove', handleMove, { passive: false });
    bohrCanvas.addEventListener('touchend', handleEnd);
    bohrCanvas.addEventListener('touchcancel', handleEnd);
    
    // ========================================
    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    // ========================================
    document.getElementById('resetBtn').addEventListener('click', () => {
      state.electronN = 6;
      state.lastTransition = null;
      state.emittedPhotons = [];
      document.getElementById('transitionInfo').innerHTML = 
        'é›»å­ã‚’ç§»å‹•ã•ã›ã‚‹ã¨<br>ã“ã“ã«æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br><span style="color:var(--text-dim);font-size:0.7rem;">å†…å´â†’æ”¾å‡º / å¤–å´â†’åŠ±èµ·</span>';
    });
    
    document.getElementById('clearSpectrumBtn').addEventListener('click', () => {
      state.spectrumLines = [];
    });
    
    document.getElementById('showLyman').addEventListener('change', (e) => {
      state.filters.lyman = e.target.checked;
    });
    
    document.getElementById('showBalmer').addEventListener('change', (e) => {
      state.filters.balmer = e.target.checked;
    });
    
    document.getElementById('showPaschen').addEventListener('change', (e) => {
      state.filters.paschen = e.target.checked;
    });
    
    // ========================================
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
    // ========================================
    function animate() {
      drawBohrModel();
      drawEnergyDiagram();
      drawSpectrum();
      requestAnimationFrame(animate);
    }
    
    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        resizeCanvases();
      }, 100);
    });
    
    // ç”»é¢å›è»¢å¯¾å¿œ
    window.addEventListener('orientationchange', () => {
      setTimeout(resizeCanvases, 200);
    });
    
    resizeCanvases();
    animate();
  </script>
</body>
</html>
